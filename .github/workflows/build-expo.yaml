on:
  push:
    branches:
      - master

jobs:
  update:
    name: EAS Update
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check for EXPO_TOKEN
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Bump version
        if: "!contains(github.event.head_commit.message, 'chore: bump version')"
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Bump version in package.json and create a git tag
          npm version minor -m "chore: bump version to %s"
          
          # Extract new version from package.json
          NEW_VERSION=$(node -p "require('./package.json').version")
          
          # Update the version in app.json using a Node.js script
          node -e "
            const fs = require('fs');
            const appJsonPath = './app.json';
            const appJson = JSON.parse(fs.readFileSync(appJsonPath));
            appJson.expo.version = '$NEW_VERSION';
            fs.writeFileSync(appJsonPath, JSON.stringify(appJson, null, 2) + '\n');
            console.log(`Updated app.json to version ${appJson.expo.version}`);
          "
          
          # Add the modified app.json to the commit
          git add app.json
          git commit --amend --no-edit
          
          # Push the commit and tags back to the repository
          git push
          git push --tags

      - name: Create preview
        uses: expo/expo-github-action/preview@v8
        with:
          command: eas update --auto
